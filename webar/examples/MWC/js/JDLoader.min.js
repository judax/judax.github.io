THREE.JDLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.JDLoader.prototype={constructor:THREE.JDLoader,load:function(a,b,c,d){var e=this,f=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:THREE.Loader.prototype.extractUrlBase(a),g=new THREE.XHRLoader(this.manager);g.load(a,function(a){e.loadText(a,b,f)},c,d)},loadText:function(a,b,c){var d=JSON.parse(a);if(d){var e=this.parse(d,c);b(e)}},setTexturePath:function(a){this.texturePath=a},parse:function(a,b){function i(){var b,d,a=new THREE.Sphere,e=0,f=0,h=0,i=[],j=[],l=new THREE.Vector3(0,0,0),m=new THREE.Vector3(0,0,0);if(g&&g.length){for(b=0;b<g.length;++b)g[b].boundingSphere||g[b].computeBoundingSphere(),f+=g[b].boundingSphere.radius;if(f>0){for(b=0;b<g.length;++b)d=g[b],j.push(d.boundingSphere.radius),i.push(d.boundingSphere.center),m.copy(d.boundingSphere.center),m.multiplyScalar(d.boundingSphere.radius/f),l.add(m);for(b=0;b<g.length;++b){var n=l.distanceTo(i[b]);n>=e&&(e=n,h=e+j[b])}a.center=l,a.radius=h}}return a}function j(a){if(a&&a.skin&&a.skin.skinBones.length&&a.skin.skinWeights.length)return f;var b=[];b.push(f[0]);var c=f[a.node],d={};return d.name=c.name,d.parent=0,d.pos=[c.pos[0],c.pos[1],c.pos[2]],d.scl=[c.scl[0],c.scl[1],c.scl[2]],d.rotq=[c.rotq[0],c.rotq[1],c.rotq[2],c.rotq[3]],b.push(d),b}function k(){if(e=[],void 0!==a.materials&&0!==a.materials.length){var c=new THREE.TextureLoader;c.setCrossOrigin(d.crossOrigin);var f,g,h,i,j,k=0,l=0,m=!1;for(k=0;k<a.materials.length;++k){var n=a.materials[k];if(h=new THREE.Color(16777215),i=new THREE.Color(1644825),n.diffuse&&h.fromArray(n.diffuse),n.specular&&i.fromArray(n.specular),j=void 0!==n.glossiness?n.glossiness:40,f=void 0,n.maps)for(var o=0;o<n.maps.length;++o)if("diffuse"==n.maps[o].type&&""!=n.maps[o].file){var p=!1,q=n.maps[o].file.substring(n.maps[o].file.lastIndexOf(".")+1);if(q=q.toLowerCase(),q="jpg"==q?"jpeg":q,void 0!==n.maps[o].data&&("bmp"==q||"png"==q||"jpeg"==q||"gif"==q)){var r="",s=n.maps[o].data,t=s.length;for(l=0;l<t;++l)r+=String.fromCharCode(s[l]);var u=window.btoa(r),u="data:image/"+q+";base64,"+u;f=new THREE.Texture;var v=new Image;f.image=v,v.src=u,v.onload=function(a){return function(){a.needsUpdate=!0}}(f),p=!0}p||(f=c.load(b+n.maps[o].file)),f&&"png"==q&&(m=!0);break}g=new THREE.MeshPhongMaterial({color:h.getHex(),specular:i.getHex(),shininess:j,shading:THREE.SmoothShading,skinning:!0}),f&&(g.map=f),void 0!==n.opacity&&(g.opacity=n.opacity,n.opacity<1&&(g.transparent=!0)),m&&(g.transparent=!0),e.push(g)}}}function l(){if(f=void 0!==a.hierarchy?a.hierarchy.nodes:a.nodes,Array.isArray(f)&&f.length>0)for(var b=0;b<f.length;++b)void 0!==f[b].rot&&(f[b].rotq=f[b].rot,f[b].rot=void 0);else f=[]}function m(a){var b=new THREE.Matrix4;if(!f||a<0||!f[a])return b;for(var c=a;c>=0;c=f[c].parent){var d=f[c],e=new THREE.Vector3(d.pos[0],d.pos[1],d.pos[2]),g=new THREE.Vector3(d.scl[0],d.scl[1],d.scl[2]),h=new THREE.Quaternion(d.rotq[0],d.rotq[1],d.rotq[2],d.rotq[3]),i=(new THREE.Matrix4).compose(e,h,g);b.premultiply(i)}return b}function o(b){var c=-1;if(!b||!a.materials)return 0;for(var d=0;d<b.length;++d){var e=a.materials[b[d].materialIndex];if(e&&e.maps)for(var f=0;f<e.maps.length;++f)if("diffuse"==e.maps[f].type)if(c<0)c=e.maps[f].uvsIndex;else if(c!=e.maps[f].uvsIndex)return c}return c<0?0:c}function p(){var b=a.model;if(b&&b.meshes)for(var c,d,e,h,i,k,l,n,p,q,r,t,x,A,B,C,D,E,F,G,r,H,I,J,K,Q,R=0;R<b.meshes.length;++R){if(A=0,i=new THREE.BufferGeometry,k=b.meshes[R],void 0==k)return;if(k.name&&(i.name=k.name),n=k.verts,void 0==n)return;if(q=k.vertElement,void 0==q)return;if(B=k.face,C=q.vertIndices,D=q.normals,E=q.colors,F=q.uvs,G=k.skin,r=k.node,void 0==r||!(r>=0&&r<f.length))return;if(H=f[r],!(H&&H.pos&&H.rotq&&H.scl))return;if(void 0==B)return;if(I=B.vertElementIndices,J=B.groups,!I||!J)return;K=m(r),l=C.length;var S=new Float32Array(3*l);for(p=0;p<l;++p)c=3*C[p],d=3*p,t=new THREE.Vector3(n[c],n[c+1],n[c+2]),t.applyMatrix4(K),S[d]=t.x,S[d+1]=t.y,S[d+2]=t.z;if(i.addAttribute("position",new THREE.BufferAttribute(S,3)),void 0!==F&&F.length>0){c=o(J),c=c<F.length?c:0;var x=new Float32Array(F[c]);i.addAttribute("uv",new THREE.BufferAttribute(x,2)),F.length>1&&(c=0==c?1:0,x=new Float32Array(F[c]),i.addAttribute("uv2",new THREE.BufferAttribute(x,2)))}void 0!==D&&D.length>0&&i.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(D),3));var T=new Uint32Array(I);if(i.setIndex(new THREE.BufferAttribute(T,1)),i.groups=J,h=n.length/3,!G&&H.parent>=0)for(G=k.skin={},G.skinBones=[],G.skinWeights=[],p=0;p<h;++p)G.skinBones.push([r]),G.skinWeights.push([1]);var U=[],V=[];Q=0;var W,X;if(G&&G.skinBones&&G.skinWeights&&G.skinBones.length==G.skinWeights.length)for(p=0;p<h;++p){W=new THREE.Vector4(0,0,0,0),X=new THREE.Vector4(0,0,0,0);var Y=0;for(e=0;e<4;++e)e<G.skinBones[p].length?(W.setComponent(e,G.skinBones[p][e]),X.setComponent(e,G.skinWeights[p][e]),++Y):(W.setComponent(e,0),X.setComponent(e,0));for(;Y<G.skinWeights[p].length;)X.addScalar(.25*G.skinWeights[p][Y]),++Y;U.push(W),V.push(X)}if(U.length>0&&V.length>0)for(i.addAttribute("skinIndex",new THREE.Float32Attribute(new Float32Array(4*l),4)),i.addAttribute("skinWeight",new THREE.Float32Attribute(new Float32Array(4*l),4)),p=0;p<l;++p)c=C[p],W=U[c],X=V[c],i.attributes.skinIndex.setXYZW(p,W.x,W.y,W.z,W.w),i.attributes.skinWeight.setXYZW(p,X.x,X.y,X.z,X.w);var Z=j(k);Z&&Z.length>0&&(i.bones=Z),g.push(i)}}function r(){var b=a.animation;if(b&&b.keyframeAnimations&&0!=b.keyframeAnimations.length){var e,f,h,i,j,c=b.keyframeAnimations.concat(),d=[];for(e=0;e<c.length;e++)f=s(c[e]),f&&d.push(f);if(d.length>0)for(e=0;e<g.length;++e){var k=!1;if(g[e]instanceof THREE.Geometry?k=g[e].skinIndices&&g[e].skinIndices.length>0&&g[e].skinWeights&&g[e].skinWeights.length>0:g[e]instanceof THREE.BufferGeometry&&(k=g[e].attributes.skinIndex&&g[e].attributes.skinIndex.count>0&&g[e].attributes.skinWeight&&g[e].attributes.skinWeight.count>0),k)g[e].animations=d;else for(g[e].animations=[],h=0;h<d.length;++h){var l=[];for(i=d[h].tracks.length-1;i>=0;--i)j=d[h].tracks[i].name,j!=".bones["+g[e].name+"].position"&&j!=".bones["+g[e].name+"].quaternion"&&j!=".bones["+g[e].name+"].scale"||l.push(d[h].tracks[i]);l.length>0&&g[e].animations.push(new THREE.AnimationClip(d[h].name,d[h].duration,l))}}}}function s(a){if(!a)return console.error("parseKeyFrameAnimation: no animation"),null;var b=a.fps||30,c=!0,d=a.length||-1;"frames"==a.timeline&&(c=!1,d/=b);for(var e=function(a,d,e,f){if(e&&Array.isArray(e.times)&&Array.isArray(e.values)){var g=[],h=[];if(g=g.concat(e.times),h=h.concat(e.values),!c)for(var i=0;i<g.length;++i)g[i]/=b;g&&0!=g.length&&h&&0!=h.length&&f.push(new a(d,g,h))}},g=[],h=a.name||"default",i=a.animNodes||[],j=0;j<i.length;j++){var k=i[j];if(k){var l="";void 0!==k.nodeName?l=k.nodeName:void 0!==k.nodeIndex&&(l=f[k.nodeIndex].name);var m=".bones["+l+"]";e(THREE.VectorKeyframeTrack,m+".position",k.pos,g),e(THREE.VectorKeyframeTrack,m+".scale",k.scl,g),e(THREE.QuaternionKeyframeTrack,m+".quaternion",k.rot,g)}}if(0===g.length)return null;var n=new THREE.AnimationClip(h,d,g);return n}var c=0,d=this,e=[],f=[],g=[];for(k(),l(),p(),r(),c=0;c<g.length;++c)g[c].computeFaceNormals(),g[c].computeBoundingSphere();var h=i();return{geometries:g,materials:e,boundingSphere:h}}};